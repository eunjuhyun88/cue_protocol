// ============================================================================
// üìÅ frontend/src/components/chat/EnhancedChatInterface.tsx
// üí¨ Î°úÏª¨ Ollama Ï†ÑÏö© Ï±ÑÌåÖ Ïù∏ÌÑ∞ÌéòÏù¥Ïä§ (ÏôÑÏ†Ñ Í∞úÏÑ†)
// ============================================================================

'use client';

import React, { useState, useRef, useEffect, useCallback } from 'react';
import { Send, Bot, User, Zap, Cpu, Brain, Settings, Mic } from 'lucide-react';
import { Button } from '../ui/Button';
import { StatusBadge } from '../ui/StatusBadge';
import { MessageList } from './MessageList';
import type { Message } from '../../types/chat.types';
import type { UnifiedAIPassport } from '../../types/passport.types';

interface EnhancedChatInterfaceProps {
  passport?: UnifiedAIPassport;
  backendConnected: boolean;
  user?: any;
  socketConnected?: boolean;
  onCueMining?: () => void;
}

interface OllamaModel {
  id: string;
  name: string;
  provider: string;
  description: string;
  available: boolean;
  type: 'local';
  speed: 'very-fast' | 'fast' | 'moderate' | 'slow';
  recommended?: boolean;
  size?: string;
}

export const EnhancedChatInterface: React.FC<EnhancedChatInterfaceProps> = ({
  passport,
  backendConnected,
  user,
  socketConnected = false,
  onCueMining
}) => {
  // State Management
  const [input, setInput] = useState('');
  const [messages, setMessages] = useState<Message[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [selectedModel, setSelectedModel] = useState('llama3.2:3b');
  const [availableModels, setAvailableModels] = useState<OllamaModel[]>([]);
  const [ollamaConnected, setOllamaConnected] = useState(false);
  const [isVoiceMode, setIsVoiceMode] = useState(false);
  
  // Refs
  const inputRef = useRef<HTMLTextAreaElement>(null);
  const messagesContainerRef = useRef<HTMLDivElement>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);

  // ü¶ô Î°úÏª¨ Ollama Î™®Îç∏Îì§ Ï†ïÏùò (Ïã§Ï†ú ÏÇ¨Ïö©Ïûê ÏÑ§Ïπò Î™®Îç∏ Í∏∞Î∞ò)
  const defaultOllamaModels: OllamaModel[] = [
    {
      id: 'llama3.2:3b',
      name: 'ü¶ô Llama 3.2 (3B)',
      provider: 'Meta/Ollama',
      description: 'ÏµúÏ†ÅÌôîÎêú 3B Î™®Îç∏ - 2GB, Îπ†Î•∏ ÏùëÎãµ',
      available: true,
      type: 'local',
      speed: 'fast',
      recommended: true,
      size: '2GB'
    },
    {
      id: 'llama3.2:1b',
      name: 'üöÄ Llama 3.2 (1B)',
      provider: 'Meta/Ollama',
      description: 'Ï¥àÍ≥†ÏÜç 1B Î™®Îç∏ - 1.3GB, Ïã§ÏãúÍ∞Ñ',
      available: true,
      type: 'local',
      speed: 'very-fast',
      recommended: true,
      size: '1.3GB'
    },
    {
      id: 'llama3.1:8b',
      name: 'üß† Llama 3.1 (8B)',
      provider: 'Meta/Ollama',
      description: 'Í≥†ÌíàÏßà 8B Î™®Îç∏ - 4.9GB',
      available: true,
      type: 'local',
      speed: 'moderate',
      size: '4.9GB'
    },
    {
      id: 'phi3:mini',
      name: '‚ö° Phi3 Mini',
      provider: 'Microsoft/Ollama',
      description: 'Ìö®Ïú®Ï†ÅÏù∏ ÏÜåÌòï Î™®Îç∏ - 2.2GB',
      available: true,
      type: 'local',
      speed: 'fast',
      size: '2.2GB'
    },
    {
      id: 'deepseek-coder:6.7b',
      name: 'üíª DeepSeek Coder',
      provider: 'DeepSeek/Ollama',
      description: 'ÏΩîÎî© Ï†ÑÎ¨∏ AI - 3.8GB',
      available: true,
      type: 'local',
      speed: 'moderate',
      size: '3.8GB'
    },
    {
      id: 'mistral:latest',
      name: 'üá´üá∑ Mistral 7B',
      provider: 'Mistral/Ollama',
      description: 'Ïú†ÎüΩÏÇ∞ Í≥†ÌíàÏßà Î™®Îç∏ - 4.1GB',
      available: true,
      type: 'local',
      speed: 'moderate',
      size: '4.1GB'
    }
  ];

  // Ï¥àÍ∏∞Ìôî
  useEffect(() => {
    initializeChat();
    loadChatHistory();
  }, []);

  // ÏûêÎèô Ïä§ÌÅ¨Î°§
  useEffect(() => {
    scrollToBottom();
  }, [messages]);

  // Î∞±ÏóîÎìú Ïó∞Í≤∞ Ïãú Î™®Îç∏ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
  useEffect(() => {
    if (backendConnected) {
      fetchAvailableModels();
      checkOllamaConnection();
    }
  }, [backendConnected]);

  const initializeChat = () => {
    setMessages([
      {
        id: '1',
        content: `**ü¶ô Î°úÏª¨ Ollama AI ÏãúÏä§ÌÖú Ï§ÄÎπÑÎê®**

ÏïàÎÖïÌïòÏÑ∏Ïöî! AI Passport Í∏∞Î∞ò Í∞úÏù∏ÌôîÎêú Î°úÏª¨ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§.

**ÌòÑÏû¨ ÏÑ§Ï†ï:**
‚Ä¢ **ÏÑ†ÌÉùÎêú Î™®Îç∏**: ${selectedModel}
‚Ä¢ **Í∞úÏù∏Ìôî Î†àÎ≤®**: ${passport?.personalityProfile?.type || 'ÌïôÏäµ Ï§ë...'}
‚Ä¢ **CUE ÌÜ†ÌÅ∞**: ${passport?.cueTokens || 0}
‚Ä¢ **Î∞±ÏóîÎìú ÏÉÅÌÉú**: ${backendConnected ? '‚úÖ Ïó∞Í≤∞Îê®' : '‚ùå Ïò§ÌîÑÎùºÏù∏'}

Î¨¥ÏóáÏùÑ ÎèÑÏôÄÎìúÎ¶¥ÍπåÏöî?`,
        type: 'ai',
        timestamp: new Date(),
        model: selectedModel,
        cueTokensEarned: 0
      }
    ]);
  };

  const fetchAvailableModels = async () => {
    try {
      const response = await fetch('/api/ai/models');
      const data = await response.json();
      
      if (data.success) {
        const ollamaModels = data.models.filter((model: any) => model.type === 'local');
        setAvailableModels(ollamaModels.length > 0 ? ollamaModels : defaultOllamaModels);
      } else {
        setAvailableModels(defaultOllamaModels);
      }
    } catch (error) {
      console.error('Î™®Îç∏ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞ Ïã§Ìå®:', error);
      setAvailableModels(defaultOllamaModels);
    }
  };

  const checkOllamaConnection = async () => {
    try {
      const response = await fetch('/api/ai/ollama/health');
      const data = await response.json();
      setOllamaConnected(data.connected);
    } catch (error) {
      setOllamaConnected(false);
    }
  };

  const loadChatHistory = () => {
    // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú
    try {
      const saved = localStorage.getItem('chat_history');
      if (saved) {
        const history = JSON.parse(saved);
        if (history.length > 1) { // Ï¥àÍ∏∞ Î©îÏãúÏßÄ Ïô∏Ïóê Í∏∞Î°ùÏù¥ ÏûàÎäî Í≤ΩÏö∞
          setMessages(history);
        }
      }
    } catch (error) {
      console.error('Ï±ÑÌåÖ Í∏∞Î°ù Î°úÎìú Ïã§Ìå®:', error);
    }
  };

  const saveChatHistory = useCallback((newMessages: Message[]) => {
    try {
      localStorage.setItem('chat_history', JSON.stringify(newMessages));
    } catch (error) {
      console.error('Ï±ÑÌåÖ Í∏∞Î°ù Ï†ÄÏû• Ïã§Ìå®:', error);
    }
  }, []);

  const scrollToBottom = () => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!input.trim() || isLoading) return;

    const messageText = input.trim();
    setInput('');
    setIsLoading(true);

    // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ Ï∂îÍ∞Ä
    const userMessage: Message = {
      id: Date.now().toString(),
      content: messageText,
      type: 'user',
      timestamp: new Date()
    };

    const updatedMessages = [...messages, userMessage];
    setMessages(updatedMessages);

    try {
      // Î∞±ÏóîÎìúÏóê Î©îÏãúÏßÄ Ï†ÑÏÜ°
      const response = await fetch('/api/ai/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          message: messageText,
          model: selectedModel,
          user_did: user?.did || 'local-user',
          passport_data: passport
        }),
      });

      const data = await response.json();

      if (data.success) {
        // AI ÏùëÎãµ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
        const aiMessage: Message = {
          id: (Date.now() + 1).toString(),
          content: data.message.content,
          type: 'ai',
          timestamp: new Date(),
          model: selectedModel,
          cueTokensEarned: data.message.cueTokensEarned || 0,
          responseTimeMs: data.message.responseTimeMs,
          personalContext: data.personalContext
        };

        const finalMessages = [...updatedMessages, aiMessage];
        setMessages(finalMessages);
        saveChatHistory(finalMessages);

        // CUE ÎßàÏù¥Îãù Ìä∏Î¶¨Í±∞
        if (onCueMining && data.message.cueTokensEarned > 0) {
          onCueMining();
        }
      } else {
        throw new Error(data.error || 'ÏùëÎãµ ÏÉùÏÑ± Ïã§Ìå®');
      }
    } catch (error) {
      console.error('Î©îÏãúÏßÄ Ï†ÑÏÜ° Ïã§Ìå®:', error);
      
      // ÏóêÎü¨ Î©îÏãúÏßÄ Ï∂îÍ∞Ä
      const errorMessage: Message = {
        id: (Date.now() + 1).toString(),
        content: `‚ùå **Ïó∞Í≤∞ Ïò§Î•ò**\n\n${backendConnected ? 'ÏÑúÎ≤Ñ' : 'Ollama ÏÑúÎ≤Ñ'}Ïóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\n\n**Ìï¥Í≤∞ Î∞©Î≤ï:**\n1. OllamaÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏\n2. Î∞±ÏóîÎìú ÏÑúÎ≤Ñ ÏÉÅÌÉú ÌôïÏù∏\n3. Î™®Îç∏Ïù¥ Îã§Ïö¥Î°úÎìúÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏`,
        type: 'ai',
        timestamp: new Date(),
        model: selectedModel,
        isError: true
      };

      const finalMessages = [...updatedMessages, errorMessage];
      setMessages(finalMessages);
      saveChatHistory(finalMessages);
    } finally {
      setIsLoading(false);
    }
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit(e as any);
    }
  };

  const getSpeedBadgeColor = (speed: string) => {
    switch (speed) {
      case 'very-fast': return 'bg-green-100 text-green-800';
      case 'fast': return 'bg-blue-100 text-blue-800';
      case 'moderate': return 'bg-yellow-100 text-yellow-800';
      case 'slow': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  return (
    <div className="h-full flex flex-col bg-white">
      {/* Ï±ÑÌåÖ Ìó§Îçî */}
      <div className="border-b border-gray-200 p-4 bg-white sticky top-0 z-10">
        <div className="flex items-center justify-between">
          <div className="flex items-center space-x-3">
            <div className="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center">
              <Bot className="w-6 h-6 text-white" />
            </div>
            <div>
              <h2 className="font-bold text-gray-900">Î°úÏª¨ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏</h2>
              <p className="text-sm text-gray-500">
                {passport?.personalityProfile?.type || 'Learning...'} ‚Ä¢ {passport?.cueTokens || 0} CUE
              </p>
            </div>
          </div>
          
          <div className="flex items-center space-x-2">
            <StatusBadge variant={ollamaConnected ? 'success' : 'warning'} size="sm">
              ü¶ô {ollamaConnected ? 'Ollama Ïó∞Í≤∞Îê®' : 'Ollama Ïò§ÌîÑÎùºÏù∏'}
            </StatusBadge>
            <StatusBadge variant={backendConnected ? 'success' : 'warning'} size="sm">
              {backendConnected ? 'Î∞±ÏóîÎìú Ïó∞Í≤∞Îê®' : 'Ïò§ÌîÑÎùºÏù∏ Î™®Îìú'}
            </StatusBadge>
          </div>
        </div>

        {/* Î™®Îç∏ ÏÑ†ÌÉùÍ∏∞ */}
        <div className="mt-4">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            AI Î™®Îç∏ ÏÑ†ÌÉù
          </label>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
            {availableModels.map((model) => (
              <button
                key={model.id}
                onClick={() => setSelectedModel(model.id)}
                className={`p-3 rounded-lg border text-left transition-all ${
                  selectedModel === model.id
                    ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <div className="flex items-center justify-between mb-1">
                  <span className="font-medium text-sm">{model.name}</span>
                  {model.recommended && (
                    <span className="text-xs bg-yellow-100 text-yellow-800 px-1 rounded">
                      Ï∂îÏ≤ú
                    </span>
                  )}
                </div>
                <p className="text-xs text-gray-500 mb-2">{model.description}</p>
                <div className="flex items-center space-x-2">
                  <span className={`text-xs px-2 py-1 rounded ${getSpeedBadgeColor(model.speed)}`}>
                    {model.speed === 'very-fast' ? 'Îß§Ïö∞Îπ†Î¶Ñ' : 
                     model.speed === 'fast' ? 'Îπ†Î¶Ñ' : 
                     model.speed === 'moderate' ? 'Î≥¥ÌÜµ' : 'ÎäêÎ¶º'}
                  </span>
                  {model.size && (
                    <span className="text-xs text-gray-500">{model.size}</span>
                  )}
                </div>
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Î©îÏãúÏßÄ ÏòÅÏó≠ - ÎèÖÎ¶Ω Ïä§ÌÅ¨Î°§ */}
      <div 
        ref={messagesContainerRef}
        className="flex-1 overflow-y-auto p-4 space-y-4"
        style={{ maxHeight: 'calc(100vh - 300px)' }}
      >
        <MessageList messages={messages} />
        <div ref={messagesEndRef} />
      </div>

      {/* Ï±ÑÌåÖ ÏûÖÎ†• ÏòÅÏó≠ - ÌïòÎã® Í≥†Ï†ï */}
      <div className="border-t border-gray-200 p-4 bg-white sticky bottom-0">
        <form onSubmit={handleSubmit} className="space-y-3">
          <div className="flex items-end space-x-3">
            <div className="flex-1">
              <textarea
                ref={inputRef}
                value={input}
                onChange={(e) => setInput(e.target.value)}
                onKeyDown={handleKeyDown}
                placeholder={`${selectedModel}ÏóêÍ≤å Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî... (Shift+EnterÎ°ú Ï§ÑÎ∞îÍøà)`}
                className="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                rows={3}
                disabled={isLoading}
              />
            </div>
            
            <div className="flex flex-col space-y-2">
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={() => setIsVoiceMode(!isVoiceMode)}
                className={isVoiceMode ? 'bg-red-50 border-red-200' : ''}
              >
                <Mic className={`w-4 h-4 ${isVoiceMode ? 'text-red-600' : 'text-gray-600'}`} />
              </Button>
              
              <Button
                type="submit"
                disabled={!input.trim() || isLoading}
                className="px-4 py-3"
              >
                {isLoading ? (
                  <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin" />
                ) : (
                  <Send className="w-4 h-4" />
                )}
              </Button>
            </div>
          </div>
          
          {/* ÏÉÅÌÉú ÌëúÏãú */}
          <div className="flex items-center justify-between text-xs text-gray-500">
            <div className="flex items-center space-x-4">
              <span>Î™®Îç∏: {selectedModel}</span>
              <span>ÌÜ†ÌÅ∞: {passport?.cueTokens || 0} CUE</span>
              {isLoading && <span className="text-blue-600">AIÍ∞Ä ÏùëÎãµ Ï§ë...</span>}
            </div>
            
            <div className="flex items-center space-x-2">
              {socketConnected && (
                <div className="flex items-center space-x-1">
                  <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse" />
                  <span className="text-green-600">Ïã§ÏãúÍ∞Ñ</span>
                </div>
              )}
            </div>
          </div>
        </form>
      </div>
    </div>
  );
};