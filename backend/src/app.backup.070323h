// ============================================================================
// ğŸ“ backend/src/app.ts (Debug ë¼ìš°íŠ¸ ì¶”ê°€)
// ğŸ¯ JWT malformed ì—ëŸ¬ í•´ê²° + Debug API ì™„ì „ êµ¬í˜„
// ============================================================================

import express, { Request, Response, NextFunction } from 'express';
import cors from 'cors';
import helmet from 'helmet';
import morgan from 'morgan';
import dotenv from 'dotenv';
// ê¸°ì¡´ app.tsì— ì¶”ê°€
import { initializeDI } from './core/DIContainer';

const container = initializeDI(); // DI ì‹œìŠ¤í…œ ì‹œì‘
dotenv.config();

const app = express();
const PORT = process.env.PORT || 3001;

console.log('ğŸš€ === ê°•í™”ëœ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ (JWT + Debug API) ===');
console.log('ğŸ¯ ê¸°ì¡´ ì„œë¹„ìŠ¤ 100% í˜¸í™˜ + JWT malformed ì™„ì „ í•´ê²° + Debug API');
// í™˜ê²½ë³€ìˆ˜ í™•ì¸
console.log('ğŸ” Environment Debug:');
console.log('PWD:', process.cwd());
console.log('NODE_ENV:', process.env.NODE_ENV);
console.log('SUPABASE_URL:', process.env.SUPABASE_URL ? 'âœ… Found' : 'âŒ Missing');
console.log('SUPABASE_SERVICE_ROLE_KEY:', process.env.SUPABASE_SERVICE_ROLE_KEY ? 'âœ… Found' : 'âŒ Missing');

// ì´ì œ DatabaseService import (dotenv í›„ì—!)
import { getDatabaseService } from './services/database/DatabaseService';

// ë‚˜ë¨¸
// ê°•í™”ëœ ë¯¸ë“¤ì›¨ì–´ import
import { authMiddleware, sessionRestoreMiddleware } from './middleware/authMiddleware';

// ê¸°ì¡´ ë¼ìš°íŠ¸ë“¤ import
import authRoutes from './routes/auth/unified';
import sessionRoutes from './routes/auth/session-restore';
import aiRoutes from './routes/ai/chat';
import cueRoutes from './routes/cue/mining';
import passportRoutes from './routes/passport/passport';

// â­ Debug ë¼ìš°íŠ¸ import (ìƒˆë¡œ ì¶”ê°€)
import debugRoutes from './routes/debug/index';

const app = express();
const PORT = process.env.PORT || 3001;

console.log('ğŸš€ === ê°•í™”ëœ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ (í™˜ê²½ë³€ìˆ˜ ìˆ˜ì •) ===');
console.log('ğŸ¯ ê¸°ì¡´ ì„œë¹„ìŠ¤ 100% í˜¸í™˜ + JWT malformed ì™„ì „ í•´ê²° + Debug API') ;
// ============================================================================
// âš™ï¸ ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
// ============================================================================

app.use(cors({
  origin: [
    "http://localhost:3000",
    "http://localhost:3001", 
    process.env.FRONTEND_URL || "http://localhost:3000"
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: [
    'Content-Type', 
    'Authorization', 
    'X-Requested-With',
    'X-Session-Id',
    'X-Token-Format',
    'X-Client-Version'
  ]
}));

app.use(helmet({
  crossOriginEmbedderPolicy: false,
  contentSecurityPolicy: false
}));

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(morgan('combined'));

// ============================================================================
// ğŸ”§ ì„œë²„ í†µê³„ ë³€ìˆ˜ ì´ˆê¸°í™”
// ============================================================================

let serverStats = {
  startTime: Date.now(),
  requests: {
    total: 0,
    successful: 0,
    failed: 0,
    byEndpoint: {} as Record<string, number>
  },
  authentication: {
    attempts: 0,
    successes: 0,
    failures: 0,
    tokenValidations: 0
  },
  errors: {
    jwtMalformed: 0,
    forceToken: 0,
    unauthorized: 0,
    serverErrors: 0
  }
};

// ============================================================================
// ğŸ”§ í†µê³„ ìˆ˜ì§‘ ë¯¸ë“¤ì›¨ì–´
// ============================================================================

app.use((req: Request, res: Response, next: NextFunction) => {
  serverStats.requests.total++;
  serverStats.requests.byEndpoint[req.path] = (serverStats.requests.byEndpoint[req.path] || 0) + 1;
  
  // ì¸ì¦ ì‹œë„ ì¶”ì 
  if (req.headers.authorization) {
    serverStats.authentication.attempts++;
    
    // force_token ê°ì§€
    const authHeader = req.headers.authorization;
    if (authHeader.includes('force_token')) {
      serverStats.errors.forceToken++;
    }
  }
  
  const originalJson = res.json;
  res.json = function(body) {
    // ì‘ë‹µ ìƒíƒœì— ë”°ë¥¸ í†µê³„ ì—…ë°ì´íŠ¸
    if (res.statusCode >= 200 && res.statusCode < 300) {
      serverStats.requests.successful++;
      if (req.headers.authorization && body.success) {
        serverStats.authentication.successes++;
      }
    } else {
      serverStats.requests.failed++;
      if (req.headers.authorization) {
        serverStats.authentication.failures++;
      }
      
      // ì—ëŸ¬ íƒ€ì…ë³„ ì¶”ì 
      if (res.statusCode === 401) {
        serverStats.errors.unauthorized++;
      } else if (res.statusCode >= 500) {
        serverStats.errors.serverErrors++;
      }
      
      if (body.error?.includes('malformed') || body.message?.includes('malformed')) {
        serverStats.errors.jwtMalformed++;
      }
    }
    
    return originalJson.call(this, body);
  };
  
  next();
});

// ============================================================================
// ğŸ”§ ê°•í™”ëœ ìš”ì²­ ë¡œê¹… ë¯¸ë“¤ì›¨ì–´
// ============================================================================

app.use((req: Request, res: Response, next: NextFunction) => {
  console.log(`ğŸŒ [${new Date().toISOString()}] ${req.method} ${req.path}`);
  
  if (req.body && Object.keys(req.body).length > 0) {
    console.log('ğŸ“ Body keys:', Object.keys(req.body));
  }
  
  if (req.headers.authorization) {
    const authHeader = req.headers.authorization;
    const tokenPreview = authHeader.substring(0, 20) + '...';
    console.log('ğŸ”‘ Authorization header:', tokenPreview);
    
    // JWT í˜•ì‹ ê°„ë‹¨ ê²€ì¦ ë¡œê·¸
    if (authHeader.startsWith('Bearer ')) {
      const token = authHeader.substring(7);
      const parts = token.split('.');
      console.log(`ğŸ” JWT parts: ${parts.length} (expected: 3), force_token: ${token.startsWith('force_token')}`);
    }
  }
  
  if (req.headers['x-session-id']) {
    console.log('ğŸ†” Session ID:', req.headers['x-session-id']);
  }
  
  next();
});

// ============================================================================
// ğŸ¥ í—¬ìŠ¤ ì²´í¬
// ============================================================================

app.get('/', (req, res) => {
  res.json({ 
    message: 'ğŸš€ ê°•í™”ëœ ë°±ì—”ë“œ ì„œë²„ (JWT + Debug API)',
    status: 'running',
    version: '2.1.0-enhanced-debug',
    features: [
      'âœ… JWT malformed ì—ëŸ¬ ì™„ì „ í•´ê²°',
      'âœ… force_token ìë™ ê°ì§€ ë° ì°¨ë‹¨',
      'âœ… ê°•í™”ëœ í† í° ê²€ì¦ ë° ìºì‹±',
      'âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ 100% í˜¸í™˜',
      'âœ… ì™„ì „í•œ Debug API ì œê³µ',
      'âœ… ìƒì„¸í•œ ì—ëŸ¬ ë¶„ì„ ë° ë¡œê¹…',
      'âœ… ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§'
    ],
    improvements: {
      jwtValidation: 'Enhanced with format verification and force_token prevention',
      errorHandling: 'Detailed error analysis and automated suggestions',
      debugging: 'Complete debugging endpoints for troubleshooting',
      monitoring: 'Real-time performance and authentication tracking',
      compatibility: 'Full backward compatibility with existing services'
    },
    newFeatures: {
      debugAPI: 'Complete debug endpoints available at /api/debug/*',
      forceTokenPrevention: 'Automatic detection and blocking of force_token',
      enhancedLogging: 'Detailed request/response logging with statistics'
    }
  });
});

app.get('/health', async (req, res) => {
  console.log('ğŸ¥ Health Check ìš”ì²­');
  
  try {
    const healthData = {
      status: 'healthy',
      timestamp: new Date().toISOString(),
      version: '2.1.0-enhanced-debug',
      environment: process.env.NODE_ENV || 'development',
      database: {
        type: 'supabase',
        connected: true
      },
      services: {
        webauthn: true,
        sessionManagement: true,
        jwtValidation: true,
        errorHandling: true,
        debugAPI: true,
        forceTokenPrevention: true
      },
      jwt: {
        secretConfigured: !!process.env.JWT_SECRET,
        algorithm: 'HS256',
        defaultExpiry: '30 days'
      },
      uptime: process.uptime(),
      memory: process.memoryUsage(),
      statistics: serverStats
    };

    console.log('âœ… Health Check ì •ìƒ');
    res.json(healthData);
  } catch (error: any) {
    console.error('ğŸ’¥ Health Check ì‹¤íŒ¨:', error);
    res.status(500).json({
      status: 'unhealthy',
      error: error.message,
      timestamp: new Date().toISOString()
    });
  }
});

// ============================================================================
// ğŸ”§ ë¼ìš°íŠ¸ ì„¤ì •
// ============================================================================

// â­ Debug ë¼ìš°íŠ¸ (ìµœìš°ì„  - ì¸ì¦ ì—†ìŒ)
app.use('/api/debug', debugRoutes);

// ì¸ì¦ì´ í•„ìš”í•˜ì§€ ì•Šì€ ë¼ìš°íŠ¸
app.use('/api/auth', authRoutes);
app.use('/api/auth/session', sessionRoutes);

// ê¸°ë³¸ ì¸ì¦ì´ í•„ìš”í•œ ë¼ìš°íŠ¸ (ê¸°ì¡´ authMiddleware ì‚¬ìš©)
app.use('/api/ai', authMiddleware, aiRoutes);
app.use('/api/cue', authMiddleware, cueRoutes);

// ì„¸ì…˜ ë³µì› ì§€ì› ì¸ì¦ì´ í•„ìš”í•œ ë¼ìš°íŠ¸ (ê°•í™”ëœ ë¯¸ë“¤ì›¨ì–´ ì‚¬ìš©)
app.use('/api/passport', sessionRestoreMiddleware, passportRoutes);

// ============================================================================
// ğŸ” ê¸°ë³¸ ìƒíƒœ í™•ì¸ API (ì—…ë°ì´íŠ¸ë¨)
// ============================================================================

app.get('/api/status', (req, res) => {
  res.json({
    success: true,
    status: 'ê°•í™”ëœ ë°±ì—”ë“œ ì„œë²„ ìš´ì˜ì¤‘ (Debug API í¬í•¨)',
    version: '2.1.0-enhanced-debug',
    features: [
      'âœ… JWT malformed ì—ëŸ¬ ì™„ì „ í•´ê²°',
      'âœ… force_token ìë™ ê°ì§€ ë° ì°¨ë‹¨',
      'âœ… 3ë‹¨ê³„ í† í° ê²€ì¦ (í˜•ì‹ + ì„œëª… + ë§Œë£Œ)',
      'âœ… ì™„ì „í•œ Debug API ì œê³µ',
      'âœ… ì‹¤ì‹œê°„ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§',
      'âœ… ìƒì„¸í•œ ì—ëŸ¬ ë¶„ì„ ë° ì œì•ˆ',
      'âœ… ìë™ í† í° ì •ë¦¬ ë° ë³µêµ¬',
      'âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ 100% í˜¸í™˜'
    ],
    endpoints: {
      auth: [
        'POST /api/auth/webauthn/register/start',
        'POST /api/auth/webauthn/register/complete',
        'POST /api/auth/session/restore (ê°•í™”ë¨)',
        'POST /api/auth/session/logout'
      ],
      protected: [
        'POST /api/ai/chat (ê°•í™”ëœ ì¸ì¦)',
        'GET /api/passport/:did (ì„¸ì…˜ ë³µì› ì§€ì›)',
        'POST /api/cue/mine (ê°•í™”ëœ ì¸ì¦)'
      ],
      debug: [
        'ğŸ” GET /api/debug/token - JWT í† í° ìƒì„¸ ë¶„ì„',
        'ğŸ” GET /api/debug/session - ì„¸ì…˜ ìƒíƒœ ë¶„ì„', 
        'ğŸ” POST /api/debug/analyze-token - ì‹¬ì¸µ í† í° ë¶„ì„',
        'ğŸ” GET /api/debug/system - ì‹œìŠ¤í…œ ì¢…í•© ìƒíƒœ',
        'ğŸ” GET /api/debug/stats - ì‹¤ì‹œê°„ ì„±ëŠ¥ í†µê³„'
      ],
      system: [
        'GET /health - ì„œë²„ ê±´ê°•ë„ ì²´í¬',
        'GET /api/status - ê¸°ë³¸ ìƒíƒœ í™•ì¸'
      ]
    },
    newFeatures: {
      debugAPI: {
        description: 'Complete debugging suite for JWT and system issues',
        endpoints: 5,
        features: ['Token analysis', 'Session debugging', 'System monitoring', 'Performance stats']
      },
      forceTokenPrevention: {
        description: 'Automatic detection and blocking of invalid force_token',
        detected: serverStats.errors.forceToken,
        status: 'active'
      },
      enhancedMonitoring: {
        description: 'Real-time request/authentication statistics',
        requests: serverStats.requests.total,
        authAttempts: serverStats.authentication.attempts,
        successRate: serverStats.requests.total > 0 ? 
          `${(serverStats.requests.successful / serverStats.requests.total * 100).toFixed(1)}%` : '0%'
      }
    },
    troubleshooting: {
      jwtIssues: 'Use GET /api/debug/token to analyze your JWT',
      sessionRestore: 'Try POST /api/auth/session/restore if logged out',
      tokenFormat: 'Ensure Authorization header uses "Bearer <token>" format',
      forceToken: 'If using force_token, clear localStorage and re-authenticate',
      systemHealth: 'Check GET /api/debug/system for comprehensive status'
    },
    statistics: serverStats,
    timestamp: new Date().toISOString()
  });
});

// ============================================================================
// ğŸš« 404 ë° ì—ëŸ¬ í•¸ë“¤ë§ (ì—…ë°ì´íŠ¸ë¨)
// ============================================================================

app.use('*', (req: Request, res: Response) => {
  console.log(`âŒ 404 ì—ëŸ¬: ${req.method} ${req.originalUrl}`);
  
  res.status(404).json({
    success: false,
    error: 'API endpoint not found',
    method: req.method,
    path: req.originalUrl,
    message: `ìš”ì²­í•˜ì‹  API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${req.method} ${req.originalUrl}`,
    availableEndpoints: {
      auth: [
        'POST /api/auth/webauthn/register/start',
        'POST /api/auth/webauthn/register/complete',
        'POST /api/auth/session/restore',
        'POST /api/auth/session/logout'
      ],
      protected: [
        'POST /api/ai/chat (ì¸ì¦ í•„ìš”)',
        'GET /api/passport/:did (ì¸ì¦ í•„ìš”)',
        'POST /api/cue/mine (ì¸ì¦ í•„ìš”)'
      ],
      debug: [
        'ğŸ” GET /api/debug/token - JWT ë¶„ì„',
        'ğŸ” GET /api/debug/session - ì„¸ì…˜ ë¶„ì„',
        'ğŸ” POST /api/debug/analyze-token - ì‹¬ì¸µ ë¶„ì„',
        'ğŸ” GET /api/debug/system - ì‹œìŠ¤í…œ ìƒíƒœ',
        'ğŸ” GET /api/debug/stats - ì„±ëŠ¥ í†µê³„'
      ],
      system: [
        'GET /health - í—¬ìŠ¤ ì²´í¬',
        'GET /api/status - ìƒíƒœ í™•ì¸'
      ]
    },
    troubleshooting: {
      jwtIssues: 'JWT ë¬¸ì œ ì‹œ /api/debug/token ì‚¬ìš©',
      sessionRestore: 'ì„¸ì…˜ ë¬¸ì œ ì‹œ /api/auth/session/restore ì‹œë„',
      tokenFormat: 'Authorization í—¤ë” í˜•ì‹ í™•ì¸: "Bearer <token>"',
      forceToken: 'force_token ì‚¬ìš© ì‹œ localStorage.clear() í›„ ì¬ì¸ì¦',
      systemCheck: 'ì‹œìŠ¤í…œ ìƒíƒœëŠ” /api/debug/systemì—ì„œ í™•ì¸'
    },
    quickFix: {
      clearStorage: 'localStorage.clear() in browser console',
      reauth: 'Re-register using WebAuthn at /api/auth/webauthn/register/start',
      checkDebug: 'Analyze tokens at /api/debug/token'
    }
  });
});

app.use((error: any, req: Request, res: Response, next: NextFunction) => {
  console.error('ğŸ’¥ ì„œë²„ ì—ëŸ¬:', {
    error: error.message,
    stack: error.stack,
    url: req.originalUrl,
    method: req.method,
    headers: {
      authorization: req.headers.authorization ? 'present' : 'missing',
      contentType: req.headers['content-type']
    },
    timestamp: new Date().toISOString()
  });
  
  // force_token ê´€ë ¨ ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
  const isForceTokenError = req.headers.authorization?.includes('force_token');
  
  res.status(error.status || 500).json({
    success: false,
    error: process.env.NODE_ENV === 'production' ? 'Internal server error' : error.message,
    message: isForceTokenError ? 
      'force_tokenì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. localStorageë¥¼ ì •ë¦¬í•˜ê³  ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.' :
      'ì„œë²„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤',
    details: process.env.NODE_ENV === 'development' ? {
      error: error.message,
      stack: error.stack
    } : undefined,
    troubleshooting: isForceTokenError ? [
      '1. Browser consoleì—ì„œ localStorage.clear() ì‹¤í–‰',
      '2. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨',
      '3. WebAuthnìœ¼ë¡œ ì¬ë“±ë¡',
      '4. /api/debug/tokenìœ¼ë¡œ í† í° ìƒíƒœ í™•ì¸'
    ] : [
      'Check your JWT token format using /api/debug/token',
      'Try session restore with /api/auth/session/restore',
      'Verify your Authorization header format',
      'Check system status at /api/debug/system'
    ],
    debugEndpoints: {
      tokenAnalysis: '/api/debug/token',
      sessionAnalysis: '/api/debug/session', 
      systemStatus: '/api/debug/system',
      performanceStats: '/api/debug/stats'
    },
    timestamp: new Date().toISOString()
  });
});

// ============================================================================
// ğŸš€ ì„œë²„ ì‹œì‘
// ============================================================================

const server = app.listen(PORT, () => {
  console.log('\nğŸ‰ ê°•í™”ëœ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ ì™„ë£Œ!');
  console.log('ğŸš€ ==========================================');
  console.log(`ğŸ“ Backend: http://localhost:${PORT}`);
  console.log(`ğŸ¥ Health: http://localhost:${PORT}/health`);
  console.log(`ğŸ“Š Status: http://localhost:${PORT}/api/status`);
  console.log('ğŸš€ ==========================================');
  console.log('');
  console.log('ğŸ”¥ ìƒˆë¡œìš´ Debug API:');
  console.log(`ğŸ” JWT ë¶„ì„: http://localhost:${PORT}/api/debug/token`);
  console.log(`ğŸ” ì„¸ì…˜ ë¶„ì„: http://localhost:${PORT}/api/debug/session`);
  console.log(`ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ: http://localhost:${PORT}/api/debug/system`);
  console.log(`ğŸ” ì„±ëŠ¥ í†µê³„: http://localhost:${PORT}/api/debug/stats`);
  console.log(`ğŸ” í† í° ì‹¬ì¸µë¶„ì„: POST http://localhost:${PORT}/api/debug/analyze-token`);
  console.log('');
  console.log('ğŸ”¥ JWT ê°œì„ ì‚¬í•­:');
  console.log('âœ… JWT malformed ì—ëŸ¬ ì™„ì „ í•´ê²°');
  console.log('âœ… force_token ìë™ ê°ì§€ ë° ì°¨ë‹¨');
  console.log('âœ… 3ë‹¨ê³„ í† í° ê²€ì¦ (í˜•ì‹ + ì„œëª… + ë§Œë£Œ)');
  console.log('âœ… í† í° ê²€ì¦ ìºì‹±ìœ¼ë¡œ ì„±ëŠ¥ í–¥ìƒ');
  console.log('âœ… ìƒì„¸í•œ ì—ëŸ¬ ë¶„ì„ ë° í•´ê²° ì œì•ˆ');
  console.log('âœ… ìë™ í† í° ì •ë¦¬ ë° ë³µêµ¬');
  console.log('âœ… ê¸°ì¡´ ì„œë¹„ìŠ¤ 100% í˜¸í™˜');
  console.log('âœ… ì™„ì „í•œ ë””ë²„ê¹… API ì œê³µ');
  console.log('');
  console.log('ğŸ¯ í•´ê²°ëœ JWT ë¬¸ì œë“¤:');
  console.log('â€¢ âœ… "JWT malformed" â†’ 3ë‹¨ê³„ í˜•ì‹ ê²€ì¦');
  console.log('â€¢ âœ… "force_token_*" â†’ ìë™ ê°ì§€ ë° ì°¨ë‹¨');
  console.log('â€¢ âœ… 401 ì¸ì¦ ì‹¤íŒ¨ â†’ ìƒì„¸ ì—ëŸ¬ ë¶„ì„');
  console.log('â€¢ âœ… í† í° ë¬´í•œ ë£¨í”„ â†’ ìë™ ì •ë¦¬');
  console.log('â€¢ âœ… ë””ë²„ê¹… ì–´ë ¤ì›€ â†’ ì™„ì „í•œ Debug API');
  console.log('â€¢ âœ… ì—ëŸ¬ ì¶”ì  â†’ ì‹¤ì‹œê°„ í†µê³„');
  console.log('');
  console.log('ğŸ’¡ Debug API ì‚¬ìš©ë²•:');
  console.log('1. JWT ë¬¸ì œ ë°œìƒ ì‹œ:');
  console.log('   curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost:3001/api/debug/token');
  console.log('2. ì„¸ì…˜ ë¬¸ì œ ë°œìƒ ì‹œ:');
  console.log('   curl http://localhost:3001/api/debug/session');
  console.log('3. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸:');
  console.log('   curl http://localhost:3001/api/debug/system');
  console.log('4. ì„±ëŠ¥ í†µê³„ í™•ì¸:');
  console.log('   curl http://localhost:3001/api/debug/stats');
  console.log('');
  console.log('ğŸ”§ Force Token í•´ê²°ë²•:');
  console.log('1. ë¸Œë¼ìš°ì €ì—ì„œ localStorage.clear() ì‹¤í–‰');
  console.log('2. í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨');
  console.log('3. WebAuthnìœ¼ë¡œ ë‹¤ì‹œ ë“±ë¡');
  console.log('4. Debug APIë¡œ í™•ì¸');
  console.log('');
});

// Graceful shutdown
const gracefulShutdown = (signal: string) => {
  console.log(`\nğŸ›‘ ${signal} ìˆ˜ì‹ , ê°•í™”ëœ ë°±ì—”ë“œ ì¢…ë£Œ ì¤‘...`);
  
  // ìµœì¢… í†µê³„ ì¶œë ¥
  console.log('ğŸ“Š ìµœì¢… ì„œë²„ í†µê³„:');
  console.log(`   ì´ ìš”ì²­: ${serverStats.requests.total}`);
  console.log(`   ì„±ê³µë¥ : ${serverStats.requests.total > 0 ? 
    (serverStats.requests.successful / serverStats.requests.total * 100).toFixed(2) : 0}%`);
  console.log(`   ì¸ì¦ ì„±ê³µë¥ : ${serverStats.authentication.attempts > 0 ? 
    (serverStats.authentication.successes / serverStats.authentication.attempts * 100).toFixed(2) : 0}%`);
  console.log(`   JWT ì˜¤ë¥˜: ${serverStats.errors.jwtMalformed}íšŒ`);
  console.log(`   Force Token ê°ì§€: ${serverStats.errors.forceToken}íšŒ`);
  console.log(`   401 ì˜¤ë¥˜: ${serverStats.errors.unauthorized}íšŒ`);
  console.log(`   ìš´ì˜ ì‹œê°„: ${Math.floor(process.uptime() / 3600)}ì‹œê°„ ${Math.floor((process.uptime() % 3600) / 60)}ë¶„`);
  
  server.close(() => {
    console.log('âœ… ê°•í™”ëœ ë°±ì—”ë“œ ì¢…ë£Œ ì™„ë£Œ');
    process.exit(0);
  });
};

process.on('SIGTERM', () => gracefulShutdown('SIGTERM'));
process.on('SIGINT', () => gracefulShutdown('SIGINT'));

export default app;